# Item Stock Analyzer
  Workflow 2, Component 4

## Written By
Randeep Ahlawat

## Description
  The component forecasts the demand for a particular item in a store using Facebook Prophet. It receives a store ID and an item name and predicts its sale in the upcoming days using previous sale data which acts as a history. The workflow manager can choose how long back the sale data needs to be looked at for training and for how many days the predictions need to be made. The predictions are then used to automatically restock the item. The component allows the workflow manager to use a flexible automatic restock strategy whether it be daily or weekly restock. Facebook Prophet provides accurate predictions and can even discern seasonality and yearly, weekly and daily trends.

## Setup
Machine requirements:
* Python 3.8
* Docker

Packages  
* build-essential
* python-dev
* python3-dev

Packages installed using pip:
* fbprophet
* cassandra-driver
* quart
* Pystan
* Cython
* cmdstanpy
* numpy
* pandas
* matplotlib
* LunarCalendar
* convertdate
* holidays
* setuptools-git
* python-dateutil
* tqdm
* requests

## Commands
* To build the docker image, use the following command in the folder containing the Dockerfile:
    ```
    docker build --rm -t trishaire/stock-analyzer path_to_c4_dockerfile
    ```
* To update Dockerhub repository:
    ```
    sudo docker login
    docker push trishaire/stock-analyzer:tag
    ```
* To create the image as a service run the following command:

  ```
  docker service create --name stock-analyzer --network myNet --publish 4000:4000 --env CASS_DB=VIP_of_Cass_Service trishaire/stock-analyzer
  ```
  * where `VIP_of_Cass_Service` is the VIP of `myNet` overlay network and `tag` is the tag of order-verifier image.

## Endpoints

### `POST /order`

#### Body

Requires a JSON object containing a [`pizza-order`](https://github.com/CPVazquez/CS6343Linear/blob/main/Workflows/WF2/Components/C1/src/pizza-order.schema.json) JSON object.

| field | type | required | description |
|-------|------|----------|-------------|
| pizza-order | `pizza-order` | true | the pizza order object |

`pizza-order` 

| field | type | required | description |
|-------|------|----------|-------------|
| orderId | string - format uuid | false | A base64 ID give to each order to identify it |
| storeId | string - format uuid | true | A base64 ID given to each store to identify it |
| custName | string | true | The name of the customer, as a single string for both first/last name |
| paymentToken | string - format uuid | true | The token for the third-party payment service that the customer is paying with |
| paymentTokenType | string | true | The type of token accepted (paypal, google pay, etc) |
| custLocation | `location` | true | The location of the customer, in degrees latitude and longitude |
| orderDate | string - date-time format | true | The date of order creation |
| pizzaList | `pizza` array | true | The list of pizzas that have been ordered |

`location`

| field | type | required | description |
|-------|------|----------|-------------|
| lat | number | false | Customer latitude in degrees |
| lon | number | false | Customer longitude in degrees |

`pizza`

| field | type | options | required | description |
|-------|------|---------|----|---|
| crustType | enum | Thin, Traditional | false | The type of crust |
| sauceType | enum | Spicy, Traditional | false | The type of sauce |
| cheeseAmt | enum | None, Light, Normal, Extra | false | The amount of cheese on the pizza |
| toppingList | enum array | Pepperoni, Sausage, Beef, Onion, Chicken, Peppers, Olives, Bacon, Pineapple, Mushrooms | false | The list of toppings added at extra cost (verified by server) |

#### Responses

| status code | status | meaning |
|-------------|--------|---------|
| 200 | OK | stock loaded into stock tracker table|
| 208 | Error Already Reported | Indicates an error occurred in a subsequent component, just return the response |

### `PUT /workflow-requests/<storeId>`

#### Parameters

| parameter | type | required | description |
|-------|------|----|---|
|storeId | string - format uuid | true | the id of the store issuing the workflow request|

#### Body

Requires a [`workflow-request`](https://github.com/CPVazquez/CS6343Linear/blob/main/Workflows/WF2/Components/C1/src/workflow-request.schema.json) JSON object. 

`workflow-request`
| field | type | options | required | description |
|-------|------|---------|----|---|
| method | enum | persistent, edge | true | the workflow deployment method |
| component-list| enum array| order-verifier, cass, delivery-assigner, stock-analyzer, restocker, order-processor | true | the components the workflow is requesting|
| origin | string - format ip | N/A| true | the ip of the host issuing the request|
| workflow-offset| integer | N/A| false | generated by the workflow manager and passed to other components|

#### Responses

| status code | status | meaning|
|---|---|---|
|201|Created| workflow successfully created|
|409|Conflict|a workflow already exists for the specified store, and thus a new one cannot be created|
| 422 | Unprocessable Entity | Request JSON is valid, but the `workflow-request` specifies an unsupported workflow |

### `PUT /workflow-update/<storeId>`

#### Parameters

| parameter | type | required | description |
|-----------|------|----------|-------------|
| storeId | string - format uuid | true | the id of the store issuing the workflow request |

#### Body

Requires a [`workflow-request`](https://github.com/CPVazquez/CS6343Linear/blob/main/Workflows/WF2/Components/C1/src/workflow-request.schema.json) JSON object. 

`workflow-request`

| field | type | options | required | description |
|-------|------|---------|----------|-------------|
| method | enum | persistent, edge | true | The workflow deployment method |
| component-list | enum array | order-verifier, cass, delivery-assigner, stock-analyzer, restocker, order-processor | true | The components the workflow is requesting |
| origin | string - format ip | N/A | true | The IP address of the host issuing the request |
| workflow-offset| integer | N/A | false | Generated by the workflow manager and passed to other components |

#### Responses

| status code | status | meaning|
|-------------|--------|--------|
| 200 | OK | The workflow was successfully updated |
| 422 | Unprocessable Entity | Request JSON is valid, but the `workflow-request` specifies an unsupported workflow |

### `DELETE /workflow-requests/<storeId>`

#### Parameters

| parameter | type | required | description |
|-------|------|----|---|
|storeId | string - format uuid| true| the id of the store whose workflow we want to delete|

#### Responses

| status code | status | meaning|
|---|---|---|
|204|No Content| the specified workflow was deleted successfully |
|404|Not Found| the specified workflow does not exist or has already been deleted

### `GET /workflow-requests/<storeId>`

#### Parameters

| parameter | type | required | description |
|-------|------|----|---|
|storeId | string - format uuid| true| the id of the store whose workflow we want to retrieve|

#### Responses

| status code | status | meaning|
|---|---|---|
|200| OK | returns the `workflow-request`|
|404| Not Found| the specified `workflow-request` does not exist and could not be retrieved|

### `GET /workflow-requests`

#### Responses

| status code | status | meaning|
|---|---|---|
|200| OK | returns all the `workflow-request`s on the stock analyzer component |


### `GET /health`

#### Responses
| status code | status | meaning|
|---|---|---|
|200| OK | The server is up and running  |
returns string `healthy` if the service is healthy

[Main README](https://github.com/CPVazquez/CS6343Linear)

# Order Processor Component

Workflow 2, Component 6

## Written By

Christopher Michael Scott

## Description

Upon receiving a pizza-order, this component assigns the `pizza-order` request an order ID
and inserts the order's information into the database.

## Setup

Machine requirements:
* Python 3.8
* Docker

Package requirements:
* pipenv

Packages installed on pipenv virtual environment:
* quart
* jsonschema
* cassandra-driver
* requests

## Commands

  * To build the image, use the following command in the folder containing the Dockerfile:
    ```
    ./build.sh
    ```

  * To update Dockerhub repository:
    ```
    sudo docker login
    docker push trishaire/order-processor:tag
    ```
    * Where `tag` is the tag of order-processor image.

  * To create the image as a service run the following command:
    ```
    docker service create --name order-processor --network myNet --publish 1000:1000 --env CASS_DB=cass_service_vip trishaire/order-processor:tag
    ```
    * Where `cass_service_vip` is the VIP of `myNet` overlay network and `tag` is the tag of order-processor image.

## Endpoints

### `POST /order`

Requires a `pizza-order` JSON object.

`pizza-order` 

| field | type | required | description |
|-------|------|----------|-------------|
| orderId | string - format uuid | false | A base64 ID give to each order to identify it |
| storeId | string - format uuid | true | A base64 ID given to each store to identify it |
| custName | string | true | The name of the customer, as a single string for both first/last name |
| paymentToken | string - format uuid | true | The token for the third-party payment service that the customer is paying with |
| paymentTokenType | string | true | The type of token accepted (paypal, google pay, etc) |
| custLocation | `location` | true | The location of the customer, in degrees latitude and longitude |
| orderDate | string - date-time format | true | The date of order creation |
| pizzaList | `pizza` array | true | The list of pizzas that have been ordered |

`location`

| field | type | required | description |
|-------|------|----------|-------------|
| lat | number | false | Customer latitude in degrees |
| lon | number | false | Customer longitude in degrees |

`pizza`

| field | type | options | required | description |
|-------|------|---------|----|---|
| crustType | enum | Thin, Traditional | false | The type of crust |
| sauceType | enum | Spicy, Traditional | false | The type of sauce |
| cheeseAmt | enum | None, Light, Normal, Extra | false | The amount of cheese on the pizza |
| toppingList | enum array | Pepperoni, Sausage, Beef, Onion, Chicken, Peppers, Olives, Bacon, Pineapple, Mushrooms | false | The list of toppings added at extra cost (verified by server) |

#### Responses

| status code | status | meaning |
|-------------|--------|---------|
| 200 | OK | pizza-order successfully processed |
| 208 | Already Reported | Indicates an error occurred in a subsequent component, just return the response |
| 400 | Bad Request | Indicates that the pizza-order processing failed and the request was rejected |
| 422 | Unprocessable Entity | A workflow does not exist for the specified store, thus the pizza-order cannot be processed |

### `PUT /workflow-requests/<storeId>`

#### Parameters

| parameter | type | required | description |
|-----------|------|----------|-------------|
| storeId | string | true | The unique identification number of the store issuing the workflow request |

#### Body

Requires a [`workflow-request`](https://github.com/CPVazquez/CS6343Linear/blob/main/Workflows/WF2/Components/C6/src/workflow-request.schema.json) JSON object.

`workflow-request`

| field | type | options | required | description |
|-------|------|---------|----------|-------------|
| method | enum | persistent, edge | true | The workflow deployment method |
| component-list | enum array | order-verifier, cass, delivery-assigner, stock-analyzer, restocker, order-processor | true | The components the workflow is requesting |
| origin | string - format ip | N/A | true | The IP address of the host issuing the request |
| workflow-offset| integer | N/A | false | Generated by the workflow manager and passed to other components |

#### Responses

| status code | status | meaning|
|-------------|--------|--------|
| 200 | OK | The workflow was successfully updated |
| 201 | Created | The workflow was successfully created |
| 400 | Bad Request | Indicates the `workflow-request` was ill-formatted |
| 409 | Conflict | A workflow already exists for the specified store, and thus a new one cannot be created |
| 422 | Unprocessable Entity | Request JSON is valid, but the `workflow-request` specifies an unsupported workflow |

### `DELETE /workflow-requests/<storeId>`

#### Parameters

| parameter | type | required | description |
|-----------|------|----------|-------------|
| storeId | string | true | The ID of the store whose workflow is to be deleted |

#### Responses

| status code | status | meaning|
|-------------|--------|--------|
| 204 | No Content | The specified workflow was deleted successfully |
| 404 | Not Found | The specified workflow does not exist or has already been deleted |

### `GET /workflow-requests/<storeId>`

#### Parameters

| parameter | type | required | description |
|-----------|------|----------|-------------|
| storeId | string | true | The ID of the store whose workflow is to be retrieved |

#### Responses

| status code | status | meaning | 
|-------------|--------|---------|
| 200 | OK | Returns the `workflow-request` |
| 404 | Not Found | The specified `workflow-request` does not exist and could not be retrieved |

### `GET /workflow-requests`

#### Responses

| status code | status | meaning |
|-------------|--------|---------|
| 200 | OK | Returns all the `workflow-request`s on the workflow manager |

### `GET /health`

#### Responses

| status code | status | meaning |
|-------------|--------|---------|
| 200 | OK | The server is up and running |

Returns string `healthy` if the service is healthy.

[Main README](https://github.com/CPVazquez/CS6343Linear)
